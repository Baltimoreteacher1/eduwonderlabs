<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Equation Builder Engine</title>
<style>
  :root{
    --bg:#f7f9fc; --card:#fff; --text:#111827; --muted:#6b7280;
    --border:#d9dfe8; --accent:#2563eb; --accent2:#111827;
    --good:#065f46; --warn:#92400e; --bad:#b91c1c;
  }
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
  header{padding:14px 18px;border-bottom:1px solid var(--border);background:#fff;position:sticky;top:0;z-index:5}
  header .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
  .title{font-weight:900;font-size:16px}
  .meta{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:12px;color:var(--muted)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px 16px 28px}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:12px}
  @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
  h2{margin:0 0 8px 0;font-size:14px}
  .small{font-size:12px;color:var(--muted)}
  .btnrow{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
  button{
    cursor:pointer;border:none;border-radius:12px;padding:10px 12px;
    font-weight:900;background:var(--accent);color:#fff;font-size:14px;
  }
  button.secondary{background:var(--accent2)}
  button.ghost{background:#fff;color:#111827;border:1px solid var(--border)}
  button:disabled{opacity:.55;cursor:not-allowed}
  button:focus,input:focus,textarea:focus{outline:3px solid rgba(17,24,39,.18);outline-offset:2px}

  .msg{display:none;white-space:pre-wrap;border-radius:14px;padding:12px;margin-top:10px;font-size:13px}
  .msg.err{border:1px solid rgba(185,28,28,.35);background:rgba(185,28,28,.06);color:var(--bad)}
  .msg.warn{border:1px solid rgba(146,64,14,.35);background:rgba(146,64,14,.06);color:var(--warn)}
  .msg.ok{border:1px solid rgba(6,95,70,.35);background:rgba(6,95,70,.06);color:var(--good)}

  .problem{border:1px solid var(--border);border-radius:14px;padding:12px;background:#fff}
  .eq{font-size:22px;font-weight:900;letter-spacing:.2px}
  .subeq{font-size:13px;color:var(--muted);margin-top:6px}
  .inputs{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  input[type="text"]{
    border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:16px;min-width:180px
  }
  .kbd{font-size:12px;color:var(--muted)}
  .steps{margin-top:10px;border-top:1px solid var(--border);padding-top:10px}
  .stepRow{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
  .chip{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;font-size:14px;font-weight:900}
  .req{color:var(--bad);font-weight:900}

  textarea{width:100%;min-height:120px;resize:vertical;padding:10px 12px;border-radius:12px;border:1px solid var(--border);font-size:14px;font-family:inherit}
  .rubric{font-size:12px;color:var(--muted);line-height:1.4}
  .rubric strong{color:#111827}
</style>
</head>
<body>

<header>
  <div class="row">
    <div>
      <div class="title" id="uiTitle">Equation Builder</div>
      <div class="meta" id="uiMeta">Adaptive practice • validation • TWR writing gate</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <span class="pill"><span>Standard:</span> <strong id="uiStandard">6.EE</strong></span>
      <span class="pill"><span>WIDA:</span> <strong id="uiWida">3-4</strong></span>
      <span class="pill"><span>Streak:</span> <strong id="uiStreak">0</strong></span>
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">

    <!-- LEFT: GAME -->
    <section class="card" aria-label="Game">
      <h2 id="uiPrompt">Solve for <span class="chip">x</span>. Enter your answer.</h2>
      <div class="small" id="uiDirections">Type your answer. Examples accepted: 0.5 or 1/2. Use Check → feedback → Next.</div>

      <div class="btnrow">
        <button class="ghost" id="btnHint" type="button">Hint</button>
        <button class="secondary" id="btnCheck" type="button">Check</button>
        <button class="ghost" id="btnNext" type="button" disabled>Next</button>
        <button class="ghost" id="btnReset" type="button">Reset</button>
      </div>

      <div class="problem">
        <div class="eq" id="eqText">3x + 5 = 20</div>
        <div class="subeq" id="eqSub">Goal: find the value of x that makes the equation true.</div>
        <div class="inputs">
          <label for="ans" style="font-weight:900;">x =</label>
          <input id="ans" type="text" inputmode="decimal" autocomplete="off" placeholder="ex: 5 or 1/2"/>
          <span class="kbd">Tip: fractions like 3/4 are OK.</span>
        </div>

        <div class="steps" id="stepsBox">
          <div class="small"><strong>Show Your Steps (optional, but helps):</strong></div>
          <div class="stepRow">
            <span class="chip">Step 1</span>
            <span class="small" id="stepHint">Undo addition/subtraction first.</span>
          </div>
        </div>
      </div>

      <div class="msg err" id="msgErr"></div>
      <div class="msg warn" id="msgWarn"></div>
      <div class="msg ok" id="msgOk"></div>
    </section>

    <!-- RIGHT: WRITING (TWR + ESOL) -->
    <aside class="card" aria-label="Writing">
      <h2>Writing to Learn (TWR) <span class="req">*</span></h2>
      <div class="small">To finish a round, explain your reasoning. Writing is part of the game.</div>

      <div style="height:8px"></div>

      <div class="small"><strong>Sentence Frame (auto by WIDA)</strong></div>
      <textarea id="twrPrompt" readonly></textarea>

      <div style="height:10px"></div>

      <div class="small"><strong>Your Response <span class="req">*</span></strong></div>
      <textarea id="twrResponse" placeholder="Write here…"></textarea>

      <div class="btnrow">
        <button class="ghost" id="btnCopy" type="button">Copy Response</button>
        <button class="ghost" id="btnClear" type="button">Clear</button>
      </div>

      <div class="small"><strong>ESOL Supports</strong></div>
      <textarea id="esolSupports" readonly></textarea>

      <div style="height:10px"></div>

      <div class="rubric">
        <strong>Quick Success Criteria (4-point):</strong><br>
        <strong>4</strong> correct + clear steps + uses math vocabulary + checks solution<br>
        <strong>3</strong> correct + explains strategy<br>
        <strong>2</strong> partially correct + limited explanation<br>
        <strong>1</strong> incomplete
      </div>
    </aside>

  </div>
</div>

<script>
(() => {
  "use strict";

  /** =========================
   * CONFIG (simple v1)
   * You can later load from configUrl like DragSort.
   * ========================= */
  const url = new URL(location.href);
  const STANDARD = url.searchParams.get("standard") || "6.EE";
  const WIDA = url.searchParams.get("wida") || "3-4";

  /** UI */
  const $ = (id) => document.getElementById(id);
  const setMsg = (id, show, text) => { const el=$(id); el.style.display=show?"block":"none"; el.textContent=text||""; };
  const clearMsgs = () => { setMsg("msgErr",false,""); setMsg("msgWarn",false,""); setMsg("msgOk",false,""); };

  $("uiStandard").textContent = STANDARD;
  $("uiWida").textContent = WIDA;

  function twrByWida(w){
    const s = String(w||"").toLowerCase();
    if (s.includes("1") || s.includes("2")) {
      return [
        "I did ______ first.",
        "Then I did ______.",
        "My answer is ______ because ______."
      ].join("\\n");
    }
    if (s.includes("3") || s.includes("4")) {
      return [
        "My strategy was ______ because ______.",
        "I solved by ______ then ______.",
        "I checked my answer by ______."
      ].join("\\n");
    }
    return [
      "Explain your strategy and justify each step.",
      "Explain how you verified your solution works in the original equation."
    ].join("\\n");
  }

  $("twrPrompt").value = twrByWida(WIDA);
  $("esolSupports").value = [
    "Key words: equation, variable, inverse operation, isolate, solution.",
    "Sentence starter: I used ______ to isolate x because ______.",
    "Check: substitute x back into the equation."
  ].join("\\n");

  /** =========================
   * Math helpers (accept decimals & fractions)
   * ========================= */
  function parseNumberFlexible(s){
    const t = String(s||"").trim();
    if(!t) return null;

    // allow leading/trailing spaces, commas not allowed
    if (/^-?\d+(\.\d+)?$/.test(t)) return { value: Number(t), repr:t };

    // fraction a/b
    const m = t.match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
    if(m){
      const a = Number(m[1]), b = Number(m[2]);
      if(b === 0) return null;
      return { value: a / b, repr: `${a}/${b}` };
    }

    return null;
  }

  function nearlyEqual(a,b){
    return Math.abs(a-b) < 1e-9;
  }

  /** =========================
   * Adaptive item generator (v1)
   * Starts easy → ramps if correct.
   * ========================= */
  let streak = 0;
  let difficulty = 1; // 1 easy, 2 medium, 3 harder
  let current = null;

  function genProblem(){
    // ramp difficulty based on streak
    if(streak >= 2) difficulty = 2;
    if(streak >= 4) difficulty = 3;
    if(streak === 0) difficulty = 1;

    // types: one-step add/sub; one-step mult/div; two-step
    const types = difficulty === 1 ? ["addsub","muldiv"] :
                  difficulty === 2 ? ["muldiv","twoStep"] :
                  ["twoStep","twoStepFrac"];

    const pick = types[Math.floor(Math.random()*types.length)];

    if(pick === "addsub"){
      // x + a = b
      const a = randInt(2,12);
      const x = randInt(1,15);
      const b = x + a;
      return { text: `x + ${a} = ${b}`, answer: x, hint:"Subtract the constant from both sides." };
    }

    if(pick === "muldiv"){
      // ax = b
      const a = randInt(2,9);
      const x = randInt(2,12);
      const b = a * x;
      return { text: `${a}x = ${b}`, answer: x, hint:"Divide both sides by the coefficient." };
    }

    if(pick === "twoStep"){
      // ax + c = b
      const a = randInt(2,9);
      const x = randInt(2,12);
      const c = randInt(2,15);
      const b = a*x + c;
      return { text: `${a}x + ${c} = ${b}`, answer: x, hint:"Undo addition/subtraction first, then divide." };
    }

    // twoStepFrac: x/2 + c = b  OR  (3/4)x = b
    const variant = Math.random() < 0.5 ? "half" : "fracCoef";
    if(variant === "half"){
      const x = randInt(2,18);
      const c = randInt(1,10);
      const b = x/2 + c;
      // keep b .5-friendly
      const bStr = Number.isInteger(b) ? String(b) : String(b);
      return { text: `x/2 + ${c} = ${bStr}`, answer: x, hint:"Subtract c, then multiply by 2." };
    } else {
      const num = 3, den = 4;
      const x = randInt(4,20);
      const b = (num/den)*x;
      const bStr = Number.isInteger(b) ? String(b) : String(b);
      return { text: `(${num}/${den})x = ${bStr}`, answer: x, hint:"Multiply both sides by the reciprocal (4/3)." };
    }
  }

  function randInt(a,b){
    return Math.floor(Math.random()*(b-a+1))+a;
  }

  function loadProblem(){
    clearMsgs();
    current = genProblem();
    $("eqText").textContent = current.text;
    $("stepHint").textContent = current.hint;
    $("ans").value = "";
    $("btnNext").disabled = true;
    $("uiStreak").textContent = String(streak);
    $("ans").focus();
  }

  /** =========================
   * Writing gate
   * ========================= */
  function writingOk(){
    const txt = ($("twrResponse").value || "").trim();
    return txt.length >= 40;
  }

  /** =========================
   * Check logic + feedback
   * ========================= */
  function check(){
    clearMsgs();
    const parsed = parseNumberFlexible($("ans").value);
    if(!parsed){
      setMsg("msgErr", true, "Enter a number like 5, 0.5, or a fraction like 1/2.");
      return;
    }

    const ok = nearlyEqual(parsed.value, current.answer);
    if(ok){
      // require writing to fully pass
      if(!writingOk()){
        setMsg("msgWarn", true, "Math is correct ✅\nNow write your explanation (at least ~40 characters) to complete the round.");
        $("btnNext").disabled = true;
        return;
      }

      streak++;
      setMsg("msgOk", true, "Correct ✅\nYou solved it AND explained your thinking.\nClick Next.");
      $("btnNext").disabled = false;
    } else {
      streak = 0;
      // misconception-aware feedback (simple v1)
      const msg = [
        "Not yet.",
        "Check your inverse operation:",
        "• Undo addition/subtraction first",
        "• Then undo multiplication/division",
        "Also: substitute your x back into the equation to verify."
      ].join("\n");
      setMsg("msgErr", true, msg);
      $("btnNext").disabled = true;
    }

    $("uiStreak").textContent = String(streak);
  }

  function hint(){
    clearMsgs();
    setMsg("msgWarn", true, "Hint:\n" + current.hint + "\n\nTry writing your steps as you work.");
  }

  function reset(){
    streak = 0;
    $("twrResponse").value = "";
    loadProblem();
  }

  $("btnCheck").addEventListener("click", check);
  $("btnHint").addEventListener("click", hint);
  $("btnNext").addEventListener("click", loadProblem);
  $("btnReset").addEventListener("click", reset);

  // Copy/Clear writing
  $("btnCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText($("twrResponse").value || "");
      setMsg("msgWarn", true, "Copied response to clipboard.");
    }catch(_){
      setMsg("msgWarn", true, "Copy failed. Select and copy manually.");
    }
  });
  $("btnClear").addEventListener("click", ()=>{ $("twrResponse").value = ""; });

  // enter key triggers check
  $("ans").addEventListener("keydown", (e)=>{
    if(e.key === "Enter"){ e.preventDefault(); check(); }
  });

  // boot
  loadProblem();
})();
</script>

</body>
</html>