<!-- teacher.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher | EduWonderLab</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__logo" aria-hidden="true">üßë‚Äçüè´</div>
      <div class="brand__text">
        <div class="brand__title">Teacher Portal</div>
        <div class="brand__subtitle">Create assignments ‚Ä¢ Review submissions</div>
      </div>
    </div>
    <nav class="topbar__nav">
      <a class="btn btn--ghost" href="./index.html">Home</a>
      <a class="btn btn--ghost" href="./student.html">Student</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Create Assignment</h1>

      <div class="grid2">
        <div>
          <label class="label">Title</label>
          <input class="input" id="title" placeholder="e.g., Equivalent Ratios Practice" maxlength="120" />
        </div>
        <div>
          <label class="label">Grade Band (optional)</label>
          <input class="input" id="gradeBand" placeholder="e.g., Grade 6" maxlength="40" />
        </div>
      </div>

      <label class="label">Prompt</label>
      <textarea class="textarea" id="prompt" placeholder="Write the assignment directions here‚Ä¶"></textarea>

      <div class="grid2">
        <div>
          <label class="label">Class PIN (optional)</label>
          <input class="input" id="classPin" placeholder="e.g., 601" maxlength="20" />
          <p class="tiny muted">If set, only students who enter this PIN will see it.</p>
        </div>
        <div>
          <label class="label">Assignment ID (auto)</label>
          <input class="input mono" id="assignmentId" placeholder="(generated on save)" readonly />
        </div>
      </div>

      <div class="row row--space">
        <div class="tiny muted" id="createMsg"></div>
        <button class="btn" id="btnCreate">Publish</button>
      </div>
    </section>

    <section class="card">
      <div class="row row--space">
        <h2>Assignments</h2>
        <div class="row">
          <button class="btn btn--ghost btn--sm" id="btnRefreshA">Refresh</button>
          <button class="btn btn--ghost btn--sm" id="btnExportA">Export CSV</button>
        </div>
      </div>

      <div id="assignments" class="stack"></div>
    </section>

    <section class="card">
      <div class="row row--space">
        <h2>Submissions</h2>
        <div class="row">
          <input class="input input--sm mono" id="filterAssignmentId" placeholder="Filter by assignmentId (optional)" />
          <button class="btn btn--ghost btn--sm" id="btnRefreshS">Refresh</button>
          <button class="btn btn--ghost btn--sm" id="btnExportS">Export CSV</button>
        </div>
      </div>

      <div id="submissions" class="stack"></div>
    </section>
  </main>

  <script src="./config.js"></script>
  <script src="./app.js"></script>
  <script>
    (function teacherPage() {
      const $ = (id) => document.getElementById(id);

      const state = {
        assignments: [],
        submissions: []
      };

      function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, (c) => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
      }

      function renderAssignments(items) {
        const wrap = $('assignments');
        wrap.innerHTML = '';
        if (!items.length) {
          wrap.innerHTML = `<div class="empty">No assignments yet.</div>`;
          return;
        }

        for (const a of items) {
          const div = document.createElement('div');
          div.className = 'card card--tight';
          div.innerHTML = `
            <div class="row row--space">
              <div>
                <div class="card__title">${escapeHtml(a.title || 'Untitled')}</div>
                <div class="tiny muted mono">id: ${escapeHtml(a.id || '')}</div>
                <div class="tiny muted">${a.classPin ? 'PIN: ' + escapeHtml(a.classPin) : 'No PIN'}</div>
              </div>
              <div class="row">
                <button class="btn btn--sm btn--ghost" data-copy="${escapeHtml(a.id)}">Copy ID</button>
                <button class="btn btn--sm" data-view="${escapeHtml(a.id)}">View</button>
              </div>
            </div>
            <div class="muted">${escapeHtml(a.prompt || '')}</div>
          `;
          wrap.appendChild(div);
        }

        wrap.querySelectorAll('[data-copy]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-copy');
            await navigator.clipboard.writeText(id);
            btn.textContent = 'Copied';
            setTimeout(() => (btn.textContent = 'Copy ID'), 900);
          });
        });

        wrap.querySelectorAll('[data-view]').forEach(btn => {
          btn.addEventListener('click', () => {
            $('filterAssignmentId').value = btn.getAttribute('data-view');
            loadSubmissions();
          });
        });
      }

      function renderSubmissions(items) {
        const wrap = $('submissions');
        wrap.innerHTML = '';

        if (!items.length) {
          wrap.innerHTML = `<div class="empty">No submissions yet.</div>`;
          return;
        }

        for (const s of items) {
          const div = document.createElement('div');
          div.className = 'card card--tight';
          div.innerHTML = `
            <div class="row row--space">
              <div>
                <div class="card__title">${escapeHtml(s.studentName || 'Student')}</div>
                <div class="tiny muted mono">assignmentId: ${escapeHtml(s.assignmentId || '')}</div>
                <div class="tiny muted">submitted: ${escapeHtml(formatDate(s.submittedAt))}</div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="tiny muted">Response</div>
            <div class="mono pre">${escapeHtml(s.response || '')}</div>
            ${s.steps ? `<div class="divider"></div><div class="tiny muted">Steps</div><div class="mono pre">${escapeHtml(s.steps)}</div>` : ''}
            ${s.reflection ? `<div class="divider"></div><div class="tiny muted">Reflection</div><div class="mono pre">${escapeHtml(s.reflection)}</div>` : ''}
          `;
          wrap.appendChild(div);
        }
      }

      function formatDate(iso) {
        if (!iso) return '';
        try {
          const d = new Date(iso);
          return d.toLocaleString();
        } catch { return String(iso); }
      }

      async function createAssignment() {
        $('createMsg').textContent = '';
        const title = $('title').value.trim();
        const prompt = $('prompt').value.trim();

        if (!title || !prompt) {
          $('createMsg').textContent = 'Title + prompt are required.';
          return;
        }

        const payload = {
          title,
          prompt,
          gradeBand: $('gradeBand').value.trim(),
          classPin: $('classPin').value.trim(),
          createdAt: new Date().toISOString()
        };

        try {
          $('btnCreate').disabled = true;
          $('createMsg').textContent = 'Publishing‚Ä¶';
          const res = await window.EWL.apiPost('/assignments', payload);
          $('assignmentId').value = res && res.id ? res.id : '';
          $('createMsg').textContent = 'Published ‚úÖ';

          // clear fields (keep PIN optionally)
          $('title').value = '';
          $('prompt').value = '';
          $('gradeBand').value = '';

          await loadAssignments();
        } catch (e) {
          $('createMsg').textContent = 'Publish failed ‚ùå';
        } finally {
          $('btnCreate').disabled = false;
        }
      }

      async function loadAssignments() {
        try {
          $('assignments').innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
          const res = await window.EWL.apiGet('/assignments');
          const items = (res && Array.isArray(res.items)) ? res.items : [];
          state.assignments = items;
          renderAssignments(items);
        } catch (e) {
          $('assignments').innerHTML = `<div class="empty">Could not load assignments ‚ùå</div>`;
        }
      }

      async function loadSubmissions() {
        try {
          $('submissions').innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
          const filterId = $('filterAssignmentId').value.trim();
          const qs = filterId ? `?assignmentId=${encodeURIComponent(filterId)}` : '';
          const res = await window.EWL.apiGet('/submissions' + qs);
          const items = (res && Array.isArray(res.items)) ? res.items : [];
          state.submissions = items;
          renderSubmissions(items);
        } catch (e) {
          $('submissions').innerHTML = `<div class="empty">Could not load submissions ‚ùå</div>`;
        }
      }

      function toCsv(rows) {
        const esc = (v) => `"${String(v ?? '').replace(/"/g, '""')}"`;
        return rows.map(r => r.map(esc).join(',')).join('\n');
      }

      function download(filename, text) {
        const blob = new Blob([text], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportAssignments() {
        const rows = [
          ['id','title','gradeBand','classPin','createdAt','prompt']
        ];
        for (const a of state.assignments) {
          rows.push([a.id, a.title, a.gradeBand, a.classPin, a.createdAt, a.prompt]);
        }
        download('assignments.csv', toCsv(rows));
      }

      function exportSubmissions() {
        const rows = [
          ['assignmentId','studentName','classPin','submittedAt','response','steps','reflection']
        ];
        for (const s of state.submissions) {
          rows.push([s.assignmentId, s.studentName, s.classPin, s.submittedAt, s.response, s.steps, s.reflection]);
        }
        download('submissions.csv', toCsv(rows));
      }

      $('btnCreate').addEventListener('click', createAssignment);
      $('btnRefreshA').addEventListener('click', loadAssignments);
      $('btnRefreshS').addEventListener('click', loadSubmissions);
      $('btnExportA').addEventListener('click', exportAssignments);
      $('btnExportS').addEventListener('click', exportSubmissions);

      loadAssignments();
      loadSubmissions();
    })();
  </script>
</body>
</html>