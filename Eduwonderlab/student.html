<!-- student.html -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student | EduWonderLab</title>
  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__logo" aria-hidden="true">üéí</div>
      <div class="brand__text">
        <div class="brand__title">Student Portal</div>
        <div class="brand__subtitle">Complete your assignment</div>
      </div>
    </div>
    <nav class="topbar__nav">
      <a class="btn btn--ghost" href="./index.html">Home</a>
      <a class="btn btn--ghost" href="./teacher.html">Teacher</a>
    </nav>
  </header>

  <main class="wrap">
    <section class="card">
      <h1>Start</h1>
      <div class="grid2">
        <div>
          <label class="label">Your Name</label>
          <input class="input" id="studentName" placeholder="e.g., Jordan" maxlength="60" />
          <p class="tiny muted">No emails required. Keep it classroom-safe.</p>
        </div>
        <div>
          <label class="label">Class PIN (optional)</label>
          <input class="input" id="classPin" placeholder="e.g., 601" maxlength="20" />
          <p class="tiny muted">Use if your teacher gave one.</p>
        </div>
      </div>
      <button class="btn" id="btnLoad">Load Assignments</button>
      <div class="tiny muted" id="loadMsg"></div>
    </section>

    <section class="card">
      <div class="row row--space">
        <h2>Assignments</h2>
        <div class="tiny muted" id="asgnCount">‚Äî</div>
      </div>
      <div id="assignments" class="stack"></div>
    </section>

    <section class="card hidden" id="workCard">
      <div class="row row--space">
        <h2 id="workTitle">Assignment</h2>
        <button class="btn btn--ghost" id="btnCloseWork">Close</button>
      </div>

      <div class="muted" id="workPrompt"></div>

      <div class="divider"></div>

      <label class="label">Your Response</label>
      <textarea class="textarea" id="workResponse" placeholder="Type your thinking here‚Ä¶"></textarea>

      <div class="grid2">
        <div>
          <label class="label">Optional: Steps / Work</label>
          <textarea class="textarea" id="workSteps" placeholder="Show your steps‚Ä¶"></textarea>
        </div>
        <div>
          <label class="label">Optional: Reflection</label>
          <textarea class="textarea" id="workReflection" placeholder="What was hard? What helped?"></textarea>
        </div>
      </div>

      <div class="row row--space">
        <div class="tiny muted" id="submitMsg"></div>
        <button class="btn" id="btnSubmit">Submit</button>
      </div>
    </section>
  </main>

  <script src="./config.js"></script>
  <script src="./app.js"></script>
  <script>
    (function studentPage() {
      const $ = (id) => document.getElementById(id);

      const state = {
        assignments: [],
        active: null
      };

      function getStudent() {
        const name = $('studentName').value.trim();
        const pin = $('classPin').value.trim();
        return { name, pin };
      }

      function requireName() {
        const s = getStudent();
        if (!s.name) {
          $('loadMsg').textContent = 'Please type your name first.';
          $('studentName').focus();
          return null;
        }
        return s;
      }

      function renderAssignments(items) {
        const wrap = $('assignments');
        wrap.innerHTML = '';

        $('asgnCount').textContent = `${items.length} found`;

        if (!items.length) {
          wrap.innerHTML = `<div class="empty">No assignments yet. Check back soon.</div>`;
          return;
        }

        for (const a of items) {
          const div = document.createElement('div');
          div.className = 'card card--tight';
          div.innerHTML = `
            <div class="row row--space">
              <div>
                <div class="card__title">${escapeHtml(a.title || 'Untitled')}</div>
                <div class="tiny muted">${escapeHtml(a.gradeBand || '')} ${a.classPin ? '‚Ä¢ PIN: ' + escapeHtml(a.classPin) : ''}</div>
              </div>
              <button class="btn btn--sm" data-open="${escapeAttr(a.id)}">Open</button>
            </div>
            <div class="muted">${escapeHtml(a.prompt || '')}</div>
          `;
          wrap.appendChild(div);
        }

        wrap.querySelectorAll('[data-open]').forEach(btn => {
          btn.addEventListener('click', () => openAssignment(btn.getAttribute('data-open')));
        });
      }

      function openAssignment(id) {
        const a = state.assignments.find(x => x.id === id);
        if (!a) return;

        state.active = a;
        $('workTitle').textContent = a.title || 'Assignment';
        $('workPrompt').textContent = a.prompt || '';
        $('workResponse').value = '';
        $('workSteps').value = '';
        $('workReflection').value = '';
        $('submitMsg').textContent = '';
        $('workCard').classList.remove('hidden');
        window.scrollTo({ top: $('workCard').offsetTop - 12, behavior: 'smooth' });
      }

      function closeWork() {
        state.active = null;
        $('workCard').classList.add('hidden');
      }

      async function loadAssignments() {
        $('loadMsg').textContent = '';
        const s = requireName();
        if (!s) return;

        try {
          $('btnLoad').disabled = true;
          $('loadMsg').textContent = 'Loading‚Ä¶';
          const res = await window.EWL.apiGet('/assignments');
          const all = (res && Array.isArray(res.items)) ? res.items : [];

          // filter by PIN if student entered one, otherwise show all public + those without pin
          const filtered = s.pin
            ? all.filter(a => (a.classPin || '').toLowerCase() === s.pin.toLowerCase())
            : all.filter(a => !a.classPin); // only unpinned if no pin provided

          state.assignments = filtered;
          renderAssignments(filtered);
          $('loadMsg').textContent = 'Loaded ‚úÖ';
        } catch (e) {
          $('loadMsg').textContent = 'Could not load assignments ‚ùå';
        } finally {
          $('btnLoad').disabled = false;
        }
      }

      async function submit() {
        const s = requireName();
        if (!s) return;
        if (!state.active) return;

        const response = $('workResponse').value.trim();
        const steps = $('workSteps').value.trim();
        const reflection = $('workReflection').value.trim();

        if (!response) {
          $('submitMsg').textContent = 'Please write an answer before submitting.';
          $('workResponse').focus();
          return;
        }

        const payload = {
          assignmentId: state.active.id,
          studentName: s.name,
          classPin: s.pin || state.active.classPin || '',
          response,
          steps,
          reflection,
          submittedAt: new Date().toISOString()
        };

        try {
          $('btnSubmit').disabled = true;
          $('submitMsg').textContent = 'Submitting‚Ä¶';
          await window.EWL.apiPost('/submissions', payload);
          $('submitMsg').textContent = 'Submitted ‚úÖ';
          closeWork();
        } catch (e) {
          $('submitMsg').textContent = 'Submit failed ‚ùå';
        } finally {
          $('btnSubmit').disabled = false;
        }
      }

      function escapeHtml(s) {
        return String(s ?? '').replace(/[&<>"']/g, (c) => ({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
      }
      function escapeAttr(s) {
        return String(s ?? '').replace(/"/g, '&quot;');
      }

      $('btnLoad').addEventListener('click', loadAssignments);
      $('btnSubmit').addEventListener('click', submit);
      $('btnCloseWork').addEventListener('click', closeWork);

      // nice default
      $('asgnCount').textContent = '‚Äî';
    })();
  </script>
</body>
</html>v